<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>McLeodganj Trip Planner</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIX 1: Load React and Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- FIX 2: Recharts needs prop-types -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.js"></script>
    
    <!-- FIX 3: Load Recharts before Babel starts processing the script -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    
    <!-- Load Babel AFTER all libraries it needs to reference -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons (We will handle icon loading inside the Babel script for robustness) -->
    <!-- The previous 'module' script block caused a timing conflict with Babel. -->
    
    <style>
        /* Custom styles, overriding the default font and ensuring full-screen layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }
        #root {
            width: 100%;
            max-width: 480px; /* Constrain the app width for mobile-first feel */
        }
        /* Custom scrollbar for ScrollArea */
        .custom-scroll-area::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll-area::-webkit-scrollbar-thumb {
            background-color: #EC699C;
            border-radius: 3px;
        }
        .custom-scroll-area::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ======================================================================
        // 1. UTILITY AND HOOKS (Replacing backend, queryClient, and contexts)
        // ======================================================================
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // FIX: Recharts is now correctly defined globally by the script tag
        const { BarChart, Bar, Cell, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Legend } = window.Recharts;
        
        // --- Lucide Icons Import Simulation ---
        // We load them via an immediate script to make them available to Babel's scope
        const {
            DollarSign,
            TrendingUp,
            Plus,
            Trash2,
            X,
            AlertCircle,
            CheckCircle // Needed for the toast logic
        } = window.Lucide || { // Ensure default icons if Lucide module fails
            DollarSign: () => <svg className="w-6 h-6" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M16 8h-4a2 2 0 100 4h1a2 2 0 110 4h-4"/></svg>,
            TrendingUp: () => <svg className="w-6 h-6" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            Plus: (props) => <svg {...props} viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash2: (props) => <svg {...props} viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M14 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>,
            X: () => <svg className="w-5 h-5" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            AlertCircle: () => <svg className="w-5 h-5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            CheckCircle: () => <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/></svg>
        };

        /**
         * Custom hook for Local Storage persistence.
         * Replaces the entire PostgreSQL/Express backend.
         */
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(`Error reading localStorage key “${key}”:`, error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.error(`Error setting localStorage key “${key}”:`, error);
                }
            };
            return [storedValue, setValue];
        };

        // --- Minimal Toast/Alert System ---
        const useToast = () => {
            const showToast = (options) => {
                const existingToast = document.getElementById('simple-toast');
                if (existingToast) {
                    existingToast.remove();
                }

                const toast = document.createElement('div');
                toast.id = 'simple-toast';
                toast.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-sm transition-all duration-300 transform translate-y-0 opacity-100';
                
                let bgColor = 'bg-pink-500';
                let iconHtml = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'; // Default AlertCircle lookalike
                
                if (options.title === 'Success!') {
                    bgColor = 'bg-green-500';
                    iconHtml = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'; // CheckCircle lookalike
                }

                toast.classList.add(bgColor, 'text-white');
                toast.innerHTML = `
                    <div class="flex items-center space-x-2">
                        ${iconHtml}
                        <div>
                            <p class="font-bold">${options.title}</p>
                            <p>${options.description}</p>
                        </div>
                    </div>
                `;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('-translate-y-10', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }, options.duration || 3000);
            };

            return { toast: showToast };
        };

        // ======================================================================
        // 2. STYLED COMPONENTS (Minimal Shadcn replacements using Tailwind)
        // ======================================================================

        const Select = ({ value, onValueChange, children }) => {
            return (
                <select 
                    value={value} 
                    onChange={(e) => onValueChange(e.target.value)} 
                    className="flex h-8 w-full items-center justify-between rounded-lg border-2 border-pink-300 bg-white px-3 py-1 text-sm text-black shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-400"
                >
                    {children}
                </select>
            );
        };

        // Dummy components needed for structure but simplified in implementation
        const SelectTrigger = ({ id, children, className, ...props }) => <div className={className}>{children}</div>;
        const SelectValue = () => null;
        const SelectContent = ({ children }) => children;
        const SelectItem = ({ value, children }) => (
            <option key={value} value={value}>{children}</option>
        );

        const Button = ({ onClick, disabled, children, className, ...props }) => (
            <button
                onClick={onClick}
                disabled={disabled}
                className={`flex items-center justify-center bg-pink-500 text-white hover:bg-pink-600 active:bg-pink-700 transition duration-150 text-xs font-bold h-8 rounded-lg shadow-md disabled:opacity-50 ${className}`}
                {...props}
            >
                {children}
            </button>
        );

        const Input = ({ id, type, placeholder, value, onChange, className, ...props }) => (
            <input
                id={id}
                type={type}
                placeholder={placeholder}
                value={value}
                onChange={onChange}
                className={`flex h-8 w-full rounded-lg border-2 border-pink-300 bg-white px-3 py-1 text-sm text-black placeholder-black/40 shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-400 ${className}`}
                {...props}
            />
        );
        
        const Label = ({ htmlFor, children, className, ...props }) => (
            <label htmlFor={htmlFor} className={`block text-xs font-bold text-gray-700 mb-1 ${className}`} {...props}>
                {children}
            </label>
        );
        
        const ScrollArea = ({ children, className, ...props }) => (
            <div className={`overflow-y-auto custom-scroll-area ${className}`} style={{ maxHeight: 'calc(100vh - 100px)' }} {...props}>
                {children}
            </div>
        );

        const Card = ({ children, className, ...props }) => (
            <div className={`rounded-xl shadow-lg ${className}`} {...props}>
                {children}
            </div>
        );

        const CardContent = ({ children, className, ...props }) => (
            <div className={`p-4 ${className}`} {...props}>
                {children}
            </div>
        );

        // ======================================================================
        // 3. MAIN COMPONENT (ExpenseCalculator)
        // ======================================================================

        const EXPENSE_TYPES = [
            "travel", "food", "accommodation", "activities", "shopping", "miscellaneous"
        ];

        const CATEGORY_COLORS = {
            travel: "#1E40AF",        
            food: "#D97706",         
            accommodation: "#C084FC",
            activities: "#EC4899",   
            shopping: "#F59E0B",     
            miscellaneous: "#8B5CF6"
        };

        const getCategoryColor = (category) => {
            return CATEGORY_COLORS[category?.toLowerCase()] || "#A78BFA";
        };

        const ExpenseCalculator = () => {
            const { toast } = useToast();
            // Load and persist expenses using LocalStorage
            const [expenses, setExpenses] = useLocalStorage("mcleodganj_expenses_v1", []);

            const [expenseName, setExpenseName] = useState("");
            const [expenseType, setExpenseType] = useState("food");
            const [expenseAmount, setExpenseAmount] = useState("");
            const [paidBy, setPaidBy] = useState("split");
            const [expenseDate, setExpenseDate] = useState(new Date().toISOString().split("T")[0]);
            const [categoryFilter, setCategoryFilter] = useState("all");
            const [isAdding, setIsAdding] = useState(false);

            const handleAddExpense = () => {
                if (!expenseName.trim() || !expenseAmount.trim() || !expenseDate.trim()) {
                    toast({ title: "Error", description: "Please fill in all fields.", variant: "destructive" });
                    return;
                }
                const amount = parseFloat(expenseAmount);
                if (isNaN(amount) || amount <= 0) {
                    toast({ title: "Error", description: "Please enter a valid amount.", variant: "destructive" });
                    return;
                }

                setIsAdding(true);

                const newExpense = {
                    id: Date.now().toString(), 
                    name: expenseName,
                    type: expenseType,
                    amount: amount,
                    paidBy: paidBy,
                    expenseDate: expenseDate,
                    createdAt: Date.now(),
                };

                // Update LocalStorage state
                setExpenses(prevExpenses => [newExpense, ...prevExpenses].sort((a, b) => b.createdAt - a.createdAt));

                // Reset form fields
                setExpenseName("");
                setExpenseAmount("");
                setPaidBy("split");
                setExpenseDate(new Date().toISOString().split("T")[0]);

                toast({ title: "Success!", description: "Expense added successfully" });
                
                setIsAdding(false);
            };

            const handleDeleteExpense = (id) => {
                setExpenses(prevExpenses => prevExpenses.filter(e => e.id !== id));
                toast({ title: "Removed", description: "Expense deleted." });
            };

            const filteredExpenses = useMemo(() => {
                return categoryFilter === "all" ? 
                    expenses : 
                    expenses.filter((e) => e.type === categoryFilter);
            }, [expenses, categoryFilter]);

            const totalExpense = filteredExpenses.reduce((sum, exp) => sum + exp.amount, 0);

            const categoryTotals = useMemo(() => {
                return EXPENSE_TYPES.map((type) => {
                    const total = expenses.filter((e) => e.type?.toLowerCase() === type?.toLowerCase()).reduce((sum, e) => sum + e.amount, 0);
                    const displayName = type.charAt(0).toUpperCase() + type.slice(1);
                    return { name: displayName, value: total, category: type, color: getCategoryColor(type) };
                }).filter((item) => item.value > 0);
            }, [expenses]);

            const chartData = categoryTotals.length > 0 ? categoryTotals : [{ name: "No Expenses", value: 0, color: "#9CA3AF" }];

            return (
                <div className="flex flex-col gap-3 bg-white rounded-2xl border-2 border-pink-200 p-4 shadow-xl h-full">
                    <div className="flex items-center gap-2 mb-2 flex-shrink-0">
                        {DollarSign && <DollarSign className="w-6 h-6 text-pink-500" />}
                        <h3 className="text-xl font-extrabold text-gray-900">Trip Expenses</h3>
                    </div>

                    <ScrollArea className="flex-1 pb-4">
                        {/* Expense Input Form */}
                        <div className="bg-gradient-to-br from-white to-pink-50/50 p-4 rounded-xl border-2 border-pink-200 space-y-3">
                            <div>
                                <Label htmlFor="paid-by">Expense By</Label>
                                <Select value={paidBy} onValueChange={setPaidBy}>
                                    <SelectItem value="reh">Reh</SelectItem>
                                    <SelectItem value="sim">Sim</SelectItem>
                                    <SelectItem value="split">Split</SelectItem>
                                </Select>
                            </div>

                            <div>
                                <Label htmlFor="expense-date">Date</Label>
                                <Input id="expense-date" type="date" value={expenseDate} onChange={(e) => setExpenseDate(e.target.value)} />
                            </div>

                            <div>
                                <Label htmlFor="expense-name">Expense Name</Label>
                                <Input id="expense-name" placeholder="e.g., Hotel Night" value={expenseName} onChange={(e) => setExpenseName(e.target.value)} />
                            </div>

                            <div>
                                <Label htmlFor="expense-type">Type</Label>
                                <Select value={expenseType} onValueChange={setExpenseType}>
                                    {EXPENSE_TYPES.map((type) => (
                                        <SelectItem key={type} value={type}>
                                            {type.charAt(0).toUpperCase() + type.slice(1)}
                                        </SelectItem>
                                    ))}
                                </Select>
                            </div>

                            <div>
                                <Label htmlFor="expense-amount">Amount (INR)</Label>
                                <Input id="expense-amount" type="number" placeholder="0" value={expenseAmount} onChange={(e) => setExpenseAmount(e.target.value)} />
                            </div>

                            <Button onClick={handleAddExpense} disabled={isAdding} className="w-full">
                                {Plus && <Plus className="w-4 h-4 mr-1" />}
                                {isAdding ? "Adding..." : "Add Expense"}
                            </Button>
                        </div>

                        {/* Filter and Total Summary */}
                        <div className="mt-4">
                            <Label className="text-sm font-bold text-gray-700 mb-2 block">Filter by Category</Label>
                            <Select value={categoryFilter} onValueChange={setCategoryFilter}>
                                <SelectItem value="all">All Categories</SelectItem>
                                {EXPENSE_TYPES.map((type) => (
                                    <SelectItem key={type} value={type}>
                                        {type.charAt(0).toUpperCase() + type.slice(1)}
                                    </SelectItem>
                                ))}
                            </Select>
                        </div>

                        <Card className="mt-4 border-2 border-pink-300 bg-gradient-to-br from-white to-pink-50/60">
                            <CardContent className="p-4 flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-semibold text-gray-500">Total Spent</p>
                                    <p className="text-4xl font-extrabold text-pink-600">₹{totalExpense.toLocaleString()}</p>
                                </div>
                                {TrendingUp && <TrendingUp className="w-10 h-10 text-pink-500/70" />}
                            </CardContent>
                        </Card>

                        {/* Recent Expenses List */}
                        {filteredExpenses.length > 0 && (
                            <div className="mt-4">
                                <p className="text-sm font-bold text-gray-700 mb-2">Recent Expenses</p>
                                <div className="space-y-2 bg-pink-50/50 rounded-xl p-3 border-2 border-pink-200">
                                    {filteredExpenses.map((expense) => (
                                        <div key={expense.id} className="flex items-center justify-between p-3 bg-white rounded-xl border border-pink-100 shadow-sm text-sm">
                                            <div className="flex-1">
                                                <p className="font-bold text-gray-800">{expense.name}</p>
                                                <p className="text-gray-500 text-xs font-medium">{expense.type} • {(expense.paidBy || "split").charAt(0).toUpperCase() + (expense.paidBy || "split").slice(1)} • {new Date(expense.expenseDate).toLocaleDateString()}</p>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className="font-bold text-lg text-pink-600">₹{expense.amount}</span>
                                                <button onClick={() => handleDeleteExpense(expense.id)} className="p-1 text-red-400 hover:text-red-600 transition">
                                                    {Trash2 && <Trash2 className="w-4 h-4" />}
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Expense Breakdown Charts */}
                        {categoryTotals.length > 0 && (
                            <div className="space-y-4 mt-4">
                                <p className="text-sm font-bold text-gray-700">Expense Breakdown</p>

                                {/* Bar Chart */}
                                <Card className="border-2 border-pink-200 p-4">
                                    <ResponsiveContainer width="100%" height={150}>
                                        <BarChart data={chartData} margin={{ top: 5, right: 5, left: -20, bottom: 5 }}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#f0e2e8" />
                                            <XAxis dataKey="name" tick={{ fontSize: 10, fill: "#333" }} />
                                            <YAxis tick={{ fontSize: 10, fill: "#333" }} />
                                            <Tooltip formatter={(value, name) => [`₹${value.toLocaleString()}`, name]} contentStyle={{ backgroundColor: "#fff", border: "1px solid #EC699C", borderRadius: '8px', padding: '10px' }} />
                                            <Bar dataKey="value" radius={[4, 4, 0, 0]}>
                                                {chartData.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={entry.color} />
                                                ))}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                </Card>

                                {/* Pie Chart */}
                                <Card className="border-2 border-pink-200 p-4">
                                    <ResponsiveContainer width="100%" height={200}>
                                        <PieChart>
                                            <Pie 
                                                data={chartData} 
                                                cx="50%" 
                                                cy="50%" 
                                                innerRadius={40} 
                                                outerRadius={70} 
                                                fill="#8884d8" 
                                                paddingAngle={2} 
                                                dataKey="value"
                                                labelLine={false} 
                                                label={({ name, percent }) => percent > 0.05 ? `${name}` : ''}
                                            >
                                                {chartData.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={entry.color} />
                                                ))}
                                            </Pie>
                                            <Tooltip formatter={(value, name) => [`₹${value.toLocaleString()}`, name]} contentStyle={{ backgroundColor: "#fff", border: "1px solid #EC699C", borderRadius: '8px', padding: '10px' }} />
                                            <Legend layout="horizontal" align="center" verticalAlign="bottom" wrapperStyle={{ padding: '10px' }} />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </Card>
                            </div>
                        )}
                    </ScrollArea>
                </div>
            );
        };
        
        // ======================================================================
        // 4. APP INITIALIZATION
        // ======================================================================

        const App = () => {
            return (
                <div className="min-h-screen p-4 bg-gray-50">
                    <ExpenseCalculator />
                </div>
            )
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
    <!-- FIX 4: Re-include the Lucide module load script outside the main Babel block -->
    <!-- This ensures the window.Lucide object is created correctly for the script above. -->
    <script type="module">
        import {
            DollarSign,
            TrendingUp,
            Plus,
            Trash2,
            X,
            AlertCircle,
            CheckCircle 
        } from 'https://unpkg.com/lucide-react@0.417.0/dist/lucide-react.js';
        window.Lucide = {
            DollarSign,
            TrendingUp,
            Plus,
            Trash2,
            X,
            AlertCircle,
            CheckCircle
        };
    </script>
</body>
</html>
